#include "Application/ApplicationBase.h"
#include "Socket/Listen/ListenSocket.h"
using namespace YanaPServer::Socket::Listen;

namespace YanaPServer
{
namespace Application
{

// コンストラクタ
CApplicationBase::CApplicationBase(const std::function<void(PeerPtr)> &OnConnectFunction)
	: OnConnect(OnConnectFunction)
{
}

// デストラクタ
CApplicationBase::~CApplicationBase()
{
	Peers.clear();
}

// Listen開始.
bool CApplicationBase::StartListen(unsigned int Port)
{
	return CListenSocket::Build(Port,
		std::bind(&CApplicationBase::OnListen, this, std::placeholders::_1));
}

// 毎フレームの処理.
bool CApplicationBase::Service()
{
	CListenSocket::Poll();

	PeerList::iterator It = Peers.begin();
	while (It != Peers.end())
	{
		if (!(*It)->IsValid())
		{
			It = Peers.erase(It);
		}
		else
		{
			(*It)->Poll();
			++It;
		}
	}

	return Update();
}


// Listenした。
void CApplicationBase::OnListen(ISocket *pSocket)
{
	CPeerBase *pPeer = CreatePeer(pSocket);
	if (pPeer == nullptr) { return; }

	PeerSharedPtr pSharedPeer = PeerSharedPtr(pPeer);
	Peers.push_back(pSharedPeer);

	OnConnect(pSharedPeer);
}

}
}